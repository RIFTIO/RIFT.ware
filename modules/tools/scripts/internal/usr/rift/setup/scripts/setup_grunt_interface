#!/bin/bash

# 
#   Copyright 2016 RIFT.IO Inc
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.
#

# By WW 2015
pci_nic_macs=$(ls -ltr /sys/class/net/ | grep pci | awk '{print "/sys/class/net/" $NF "/address"}' | sort -V)
pci_nicnames=$(ls -ltr /sys/class/net/ | grep pci | awk '{print $9}')

# clean up old ifcfg-xxx files

echo "Current pci NICs:" 
echo "$pci_nicnames"
for i in $pci_nicnames; do
  echo "Removing /etc/sysconfig/network-scripts/ifcfg-$i"
  rm -f /etc/sysconfig/network-scripts/ifcfg-$i
done

i=0

for pci_nic_mac in $pci_nic_macs; do
  interface=eth${i}
  mac=$(cat $pci_nic_mac)
  echo "eth$i has mac address $mac"
  
  case  $i in
    0)
      ONBOOT="yes"
      NETBOOT="yes"
      BOOTPROTO="dhcp"
      ;;
    1)
      ONBOOT="yes"
      NETBOOT="no"
      BOOTPROTO="none"
      ;;
    *)
      ONBOOT="no"
      NETBOOT="no"
      BOOTPROTO="none"
      ;;
  esac

    cat > /etc/sysconfig/network-scripts/ifcfg-eth${i}  <<-END
# Generated by $0
DEVICE="$interface"
ONBOOT=$ONBOOT
NETBOOT=$NETBOOT
BOOTPROTO=$BOOTPROTO
HWADDR="$mac"
TYPE=Ethernet
NAME="$interface"
NM_CONTROLLED=no
END
    
  i=$((i+1))
done

